<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Find A Place! - Middle Ground</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <link
      rel="stylesheet"
      href="place.css"
    />
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>
  </head>
  <body>
    <main class="container">
      <!-- Top bar -->
      <header class="topbar">
        <div class="brand">
          <span
            class="brand-badge"
            aria-hidden="true"
          ></span>
          <a
            href="/"
            class="link-home"
            >Middle&nbsp;Ground</a
          >
        </div>
        <nav class="nav">
          <span id="auth-inline">
            <a
              class="btn btn-ghost"
              href="/login.html"
              >Log in</a
            >
            <a
              class="btn btn-primary"
              href="/signup.html"
              >Sign up</a
            >
          </span>
        </nav>
      </header>

      <!-- Main content -->
      <section>
        <!-- Location Information -->
        <div class="location-card">
          <h3>Current Location</h3>
          <div class="location-info">
            <div id="location">Getting location...</div>
          </div>
          <div class="location-info">
            <div>Lat: <span id="markerLat">--</span></div>
            <div>Lon: <span id="markerLon">--</span></div>
          </div>
        </div>
        <!-- Address Search -->
        <div class="location-card">
          <h3>Search for a Starting Location</h3>
          <div class="location-form">
            <div>
              <label for="search">Address or Place Name:</label>
              <input
                type="text"
                id="search"
                placeholder="e.g., Times Square, New York"
              />
            </div>
            <div>
              <button
                id="submitAddress"
                class="btn btn-primary"
              >
                Search
              </button>
            </div>
          </div>
          <p
            id="searchMsg"
            class="msg"
          ></p>
          <div
            id="searchResultsContainer"
            class="search-results"
          ></div>
        </div>
        <!-- Map -->
        <div id="mapContainer"></div>

        <!-- Venue Search -->
        <div
          class="location-card"
          id="venueSearchCard"
        >
          <h3>Find Nearby Venues</h3>
          <p>
            Find all venues near your current location and filter by category:
          </p>

          <div class="venue-form">
            <div>
              <label for="latitude">Latitude:</label>
              <input
                type="text"
                id="latitude"
              />
            </div>

            <div>
              <label for="longitude">Longitude:</label>
              <input
                type="text"
                id="longitude"
              />
            </div>

            <div class="inputGrid">
              <button
                id="submit"
                class="btn btn-primary"
              >
                Find All Places
              </button>
            </div>
          </div>
          <!-- Separator line -->
          <hr />

          <!-- Filter controls will be inserted here -->
          <div id="filterContent"></div>
        </div>

        <!-- Venue Results -->
        <div
          id="places"
          class="places-grid"
        ></div>
      </section>
    </main>
    <script src="places.js"></script>
    <script>
      // Helper function to safely parse JSON
      function tryJson(res) {
        try {
          return res.json();
        } catch (e) {
          return null;
        }
      }

      // Auth-aware rendering
      (async function renderAuth() {
        // Start with visible defaults (links already in markup)
        try {
          const res = await fetch("/api/me", { credentials: "same-origin" });
          const data = await tryJson(res);
          if (!data || !data.user) return;

          // If logged in, swap topbar auth section
          const username = data.user.username;
          const authInline = document.getElementById("auth-inline");

          if (authInline) {
            authInline.innerHTML = `
            <span style="opacity:.85; margin-right:.25rem;">Signed in as <b>${username}</b></span>
            <button class="btn btn-ghost" id="logoutBtn">Log out</button>
          `;
          }

          // Wire up logout functionality
          const logoutBtn = document.getElementById("logoutBtn");
          if (logoutBtn) {
            logoutBtn.addEventListener("click", async () => {
              try {
                await fetch("/api/logout", {
                  method: "POST",
                  credentials: "same-origin",
                });
                location.reload();
              } catch (e) {
                console.error("Logout failed:", e);
                // Fallback: redirect to login page
                window.location.href = "/login.html";
              }
            });
          }
        } catch (e) {
          // keep defaults if /api/me fails (e.g., server not running)
          console.log("Auth check failed (server might not be running):", e);
        }
      })();
    </script>
  </body>
</html>
